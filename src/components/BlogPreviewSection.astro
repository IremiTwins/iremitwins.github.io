---
// ============================================================
// src/components/BlogPreviewSection.astro — Blog Preview Cards
// ============================================================
//
// Shows the three most recent blog posts on the homepage,
// followed by an "All posts →" button linking to /blog.
//
// HOW IT WORKS:
//   1. getCollection('blog') fetches ALL .md files from
//      src/content/blog/ at build time.
//   2. We filter out drafts, sort by date (newest first),
//      and slice off the first 3.
//   3. We map over those 3 and render a card for each.
//
// WHY THIS IS POWERFUL:
//   When you add a new .md post file to src/content/blog/,
//   this section automatically updates — no code changes needed!
// ============================================================

// getCollection is the Astro function for querying content
// collections. It's only available in .astro files, not in
// regular HTML.
import { getCollection } from 'astro:content';

// ── Fetch and prepare posts ──────────────────────────────────

// 1. Fetch all blog posts
const allPosts = await getCollection('blog');

// 2. Filter out drafts, sort descending by date, take top 3.
//    - filter: keeps only posts where draft is not true
//    - sort: puts newest posts first (b.date - a.date)
//    - slice(0, 3): takes only the first 3 results
const previewPosts = allPosts
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 3);

// ── Format dates for display ─────────────────────────────────
// We convert Date objects to "Feb 2026" style strings here,
// so we can use them in the template below.
const formattedPosts = previewPosts.map(post => ({
  ...post,
  displayDate: post.data.date.toLocaleDateString('en-GB', {
    month: 'short',
    year: 'numeric',
  }),
}));
---

<!--
  id="blog" — target for the "Blog" nav link.
-->
<section class="blog section" id="blog">
  <div class="container">

    <!-- ── Section label + title ────────────────────────────── -->
    <p class="section__label">// blog</p>
    <h2 class="section__title">Latest <span class="highlight">writing</span></h2>

    <!-- ── Blog cards grid ──────────────────────────────────────
         Astro's {posts.map(...)} syntax works like Array.map()
         in JavaScript — it loops over the array and returns
         HTML for each item.                                    -->
    <div class="blog__grid">
      {formattedPosts.map(post => (
        <article class="blog-card card" data-animate>

          <!-- Meta row: date + tag pill -->
          <div class="blog-card__meta">
            <span class="blog-card__date">{post.displayDate}</span>
            <span class="blog-card__tag">{post.data.tag}</span>
          </div>

          <!-- Post title, linked to the post page -->
          <h3>
            <a href={`/blog/${post.slug}`}>{post.data.title}</a>
          </h3>

          <!-- Description / summary text -->
          <p>{post.data.description}</p>

          <!-- "Read more →" link -->
          <a href={`/blog/${post.slug}`} class="blog-card__read-more">
            Read more →
          </a>

        </article>
      ))}
    </div>

    <!-- ── "All posts" button ───────────────────────────────── -->
    <div class="blog__more">
      <a href="/blog" class="btn btn--ghost">All posts →</a>
    </div>

  </div>
</section>
