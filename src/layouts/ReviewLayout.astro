---
// ============================================================
// src/layouts/ReviewLayout.astro — Review Post Page Shell
// ============================================================
//
// SHARED layout for individual anime and game review pages.
// Both Twin 1 and Twin 2 review routes use this same layout.
//
// WHAT IT RENDERS:
//   - Cover image (if provided in frontmatter)
//   - Star rating (1-5 filled/empty stars)
//   - Title, date, and section label
//   - Description (lead paragraph)
//   - Full Markdown body via <slot />
//   - Previous / Next review navigation
//   - "Back to Twin X" link
//
// USED BY:
//   src/pages/twin1/twin1-anime-reviews/[slug].astro
//   src/pages/twin1/twin1-game-reviews/[slug].astro
//   src/pages/twin2/twin2-anime-reviews/[slug].astro
//   src/pages/twin2/twin2-game-reviews/[slug].astro
//
// PROPS:
//   post           — The full collection entry (data + slug)
//   collectionName — e.g. 'twin1-anime-reviews' or 'twin2-game-reviews'
//   backUrl        — URL for the back button, e.g. '/twin1' or '/twin2'
// ============================================================

import BaseLayout from './BaseLayout.astro';
import { getCollection } from 'astro:content';

// ── Props ─────────────────────────────────────────────────────
interface Props {
  post: {
    data: {
      title: string;
      coverImage?: string;
      rating: number;
      description: string;
      date: Date;
      prevPost?: string;
      nextPost?: string;
    };
    slug: string;
  };
  /** Collection name — e.g. 'twin1-anime-reviews' or 'twin2-game-reviews' */
  collectionName: string;
  /** URL path prefix for back link, e.g. '/twin1' or '/twin2' */
  backUrl: string;
}

const { post, collectionName, backUrl } = Astro.props;
const { title, coverImage, rating, description, date, prevPost, nextPost } = post.data;

// Format date as "Feb 2026"
const displayDate = date.toLocaleDateString('en-GB', {
  month: 'short',
  year: 'numeric',
});

// Build star arrays for rendering
const filledStars = Array.from({ length: rating }, (_, i) => i);
const emptyStars  = Array.from({ length: 5 - rating }, (_, i) => i);

// Look up prev/next entries for navigation
const allEntries = await getCollection(collectionName as any);
const findEntry = (slug: string | undefined) =>
  slug ? allEntries.find((e: any) => e.slug === slug) : undefined;

const prevEntry = findEntry(prevPost);
const nextEntry = findEntry(nextPost);

// Human-readable label for the section
// Determine whether this is an anime or game review based on the collection name
const isAnime = collectionName.includes('anime');
const sectionLabel = isAnime ? 'Anime Reviews' : 'Game Reviews';

// Determine which twin this belongs to for the back button text
const twinLabel = collectionName.startsWith('twin1') ? 'Twin 1' : 'Twin 2';

const reviewBasePath = `${backUrl}/${collectionName}`;
---

<BaseLayout
  title={`${title} — ${sectionLabel} · Iremi Twins`}
  description={description}
>
  <main class="blog-page">
    <div class="container">
      <article class="post-content">

        <!-- ── Review Header ──────────────────────────────── -->
        <div class="blog-page__header" style="text-align: center;">

          {/* Cover image if provided */}
          {coverImage && (
            <img
              src={coverImage}
              alt={`${title} cover`}
              class="review-hero__cover"
            />
          )}

          <!-- Star rating -->
          <div class="review-hero__stars" style="justify-content: center;">
            {filledStars.map(() => (
              <span class="review-card__star--filled">★</span>
            ))}
            {emptyStars.map(() => (
              <span class="review-card__star--empty">★</span>
            ))}
          </div>

          <h1 class="section__title">{title}</h1>

          <div class="post-meta" style="justify-content: center;">
            <span class="blog-card__date">{displayDate}</span>
            <span class="blog-card__tag">{sectionLabel}</span>
          </div>

          <p style="color: var(--clr-muted); margin-top: var(--space-sm);">
            {description}
          </p>
        </div>

        <!-- ── Review Body (Markdown) ─────────────────────── -->
        <slot />

        <!-- ── Navigation ─────────────────────────────────── -->
        <nav class="post-nav">
          <a href={backUrl} class="btn btn--ghost">← Back to {twinLabel}</a>

          {prevEntry && (
            <a href={`${reviewBasePath}/${(prevEntry as any).slug}`} class="btn btn--ghost">
              ← {(prevEntry as any).data.title}
            </a>
          )}

          {nextEntry && (
            <a href={`${reviewBasePath}/${(nextEntry as any).slug}`} class="btn btn--ghost">
              {(nextEntry as any).data.title} →
            </a>
          )}
        </nav>

      </article>
    </div>
  </main>
</BaseLayout>
